{% extends "app/base.html" %}
{% load myfilters %}

{% block content %}
  {% csrf_token %}

  <link rel="stylesheet" href="/static/css/bills_page.css?v=1.1.12" />

  <div id="bills-page" style="max-width: 1000px; margin: 0 auto; padding: 1rem 1rem 100px;">
    <script>
      function changeMonth(direction) {
        const monthInput = document.getElementById("month")
        const currentValue = monthInput.value

        if (!currentValue) return

        const [year, month] = currentValue.split("-").map(Number)
        let newMonth = month + direction
        let newYear = year

        if (newMonth < 1) {
          newMonth = 12
          newYear = year - 1
        } else if (newMonth > 12) {
          newMonth = 1
          newYear = year + 1
        }

        const newValue = `${newYear}-${String(newMonth).padStart(2, "0")}`
        monthInput.value = newValue

        // Trigger the change event to fire the HTMX request
        monthInput.dispatchEvent(new Event("change", { bubbles: true }))
      }
    </script>
    <div class="header">
      <div class="month-selector">
        <wa-button size="small" onclick="changeMonth(-1)" appearance="plain">
          <wa-icon name="chevron-left" label="Previous month"></wa-icon>
        </wa-button>

        <wa-input
          type="month"
          id="month"
          name="month"
          value="{{ selected_month|date:'Y-m' }}"
          hx-get="/bills"
          hx-push-url="true"
          hx-target="#bills-list"
          hx-trigger="change delay:500ms"
          hx-swap="outerHTML"
          style="width: 200px;"
        ></wa-input>

        <wa-button size="small" onclick="changeMonth(1)" appearance="plain">
          <wa-icon name="chevron-right" label="Next month"></wa-icon>
        </wa-button>
      </div>

      <div class="dropdown">
        <wa-dropdown>
          <wa-button slot="trigger" size="small" appearance="plain">
            <wa-icon name="ellipsis-vertical"></wa-icon>
          </wa-button>
          <wa-dropdown-item hx-get="/bills/copy" hx-target="body" hx-swap="beforeend">
            <wa-icon slot="icon" name="copy"></wa-icon>
            Copy
          </wa-dropdown-item>
        </wa-dropdown>
      </div>
    </div>

    {% partialdef bills-list inline %}
      <div id="bills-list">
        <div style="flex: 1 1 70%; min-width: 30vw;">
          <ul style="list-style: none; padding: 0; margin: 0 0 1rem 0;">
            {% for bill in bills %}
              {% partialdef bill-item inline %}
                <li class="bill-list-item">
                  <div>
                    {% if bill.link %}
                      <a href="{{ bill.link }}" target="_blank">{{ bill.name }}</a>
                    {% else %}
                      <span>{{ bill.name }}</span>
                    {% endif %}
                  </div>

                  <div>
                    <span>{{ bill.amount|currency }}</span>
                  </div>

                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <wa-checkbox
                      {% if bill.paid %}checked{% endif %}
                      hx-post="/bills/{{ bill.id }}/toggle"
                      hx-target="closest li"
                      hx-swap="outerHTML"
                      >Paid</wa-checkbox
                    >
                    {% if not bill.autopay %}
                      <span style="opacity: 0.6">
                        <wa-badge appearance="filled" variant="danger">Not Autopay</wa-badge>
                      </span>
                    {% endif %}
                  </div>

                  <div style="display: flex; gap: 0.5rem;">
                    <wa-button
                      size="small"
                      appearance="plain"
                      hx-get="/bills/{{ bill.id }}"
                      hx-target="body"
                      hx-swap="beforeend"
                    >
                      <wa-icon name="pencil" label="Edit"></wa-icon>
                    </wa-button>

                    <wa-button
                      size="small"
                      appearance="plain"
                      variant="danger"
                      hx-delete="/bills/{{ bill.id }}"
                      hx-trigger="confirmed"
                      hx-target="closest li"
                      hx-swap="outerHTML"
                      onclick="customConfirm().then(yes => {
                      if (yes) {
                        htmx.trigger(this, 'confirmed');
                      }
                    })"
                    >
                      <wa-icon name="trash" label="Delete"></wa-icon>
                    </wa-button>
                  </div>
                </li>
              {% endpartialdef bill-item %}
              {% empty %}
              <li style="margin: 0;">No bills for this month.</li>
            {% endfor %}
          </ul>
          <div style="padding-bottom: 1rem;">
            <wa-button hx-get="/bills/new" hx-target="body" hx-swap="beforeend">
              <wa-icon slot="start" name="plus"></wa-icon>
              Add Bill
            </wa-button>
          </div>
        </div>

        <div class="tile-container" style="padding-top: 7px;">
          <div hx-get="/bills/stats" hx-trigger="load, bills-changed from:body"></div>
          <div
            hx-get="/bills/links"
            hx-trigger="load"
            style="padding: 30px; border: 1px solid #eee; border-radius: 5px;"
          ></div>
        </div>
      </div>
    {% endpartialdef bills-list %}
  </div>
{% endblock %}
