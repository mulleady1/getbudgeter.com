{% extends "app/base.html" %}

{% block content %}
  {% csrf_token %}

  <div
    id="bills-page"
    style="max-width: 1000px; margin: 0 auto; padding: 1rem;"
    hx-on::config-request="event.detail.headers['X-CSRFToken'] = this.previousElementSibling.value"
  >
    <script>
      function changeMonth(direction) {
        const monthInput = document.getElementById("month")
        const currentValue = monthInput.value

        if (!currentValue) return

        const [year, month] = currentValue.split("-").map(Number)
        let newMonth = month + direction
        let newYear = year

        if (newMonth < 1) {
          newMonth = 12
          newYear = year - 1
        } else if (newMonth > 12) {
          newMonth = 1
          newYear = year + 1
        }

        const newValue = `${newYear}-${String(newMonth).padStart(2, "0")}`
        monthInput.value = newValue

        // Trigger the change event to fire the HTMX request
        monthInput.dispatchEvent(new Event('sl-change', { bubbles: true }));
      }
    </script>
    <div class="header">
      <div class="month-selector">
        <sl-icon-button
          name="chevron-left"
          size="small"
          onclick="changeMonth(-1)"
          title="Previous month"
        ></sl-icon-button>

        <sl-input
          type="month"
          id="month"
          name="month"
          value="{{ selected_month|date:'Y-m' }}"
          hx-get="{% url 'bills' %}"
          hx-push-url="true"
          hx-target="#bills-list"
          hx-trigger="sl-change delay:500ms"
          hx-swap="outerHTML"
          style="width: 200px;"
        ></sl-input>

        <sl-icon-button name="chevron-right" size="small" onclick="changeMonth(1)" title="Next month"></sl-icon-button>
      </div>

      <sl-dropdown>
        <sl-button slot="trigger" size="small" circle>
          <sl-icon name="three-dots-vertical"></sl-icon>
        </sl-button>
        <sl-menu>
          <sl-menu-item hx-get="{% url 'copy' %}" hx-target="body" hx-swap="beforeend">
            Copy
            <sl-icon slot="prefix" name="copy"></sl-icon>
          </sl-menu-item>
        </sl-menu>
      </sl-dropdown>
    </div>

    {% include "bills/bill_list.html" %}

    <div>
      <sl-button variant="primary" hx-get="{% url 'new_bill' %}" hx-target="body" hx-swap="beforeend">
        <sl-icon slot="prefix" name="plus"></sl-icon>
        Add Bill
      </sl-button>
    </div>
  </div>
{% endblock %}
