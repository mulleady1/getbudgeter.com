{% extends "app/base.html" %}

{% block content %}
  {% csrf_token %}

  <div
    id="bills-page"
    style="max-width: 1000px; margin: 0 auto; padding: 1rem;"
    hx-on::config-request="event.detail.headers['X-CSRFToken'] = this.previousElementSibling.value"
  >
    <script>
      function changeMonth(direction) {
        const monthInput = document.getElementById("month")
        const currentValue = monthInput.value

        if (!currentValue) return

        const [year, month] = currentValue.split("-").map(Number)
        let newMonth = month + direction
        let newYear = year

        if (newMonth < 1) {
          newMonth = 12
          newYear = year - 1
        } else if (newMonth > 12) {
          newMonth = 1
          newYear = year + 1
        }

        const newValue = `${newYear}-${String(newMonth).padStart(2, "0")}`
        monthInput.value = newValue

        // Trigger the change event to fire the HTMX request
        monthInput.dispatchEvent(new Event("change", { bubbles: true }))
      }
    </script>
    <div class="header">
      <div class="month-selector">
        <wa-button size="small" onclick="changeMonth(-1)" appearance="plain">
          <wa-icon name="chevron-left" label="Previous month"></wa-icon>
        </wa-button>

        <wa-input
          type="month"
          id="month"
          name="month"
          value="{{ selected_month|date:'Y-m' }}"
          hx-get="/"
          hx-push-url="true"
          hx-target="#bills-list"
          hx-trigger="change delay:500ms"
          hx-swap="outerHTML"
          style="width: 200px;"
        ></wa-input>

        <wa-button size="small" onclick="changeMonth(1)" appearance="plain">
          <wa-icon name="chevron-right" label="Next month"></wa-icon>
        </wa-button>
      </div>

      <div class="dropdown">
        <wa-dropdown>
          <wa-button slot="trigger" size="small" appearance="plain">
            <wa-icon name="ellipsis-vertical"></wa-icon>
          </wa-button>
          <wa-dropdown-item hx-get="{% url 'copy' %}" hx-target="body" hx-swap="beforeend">
            <wa-icon slot="icon" name="copy"></wa-icon>
            Copy
          </wa-dropdown-item>
        </wa-dropdown>
      </div>
    </div>

    {% include "bills/bill_list.html" %}

    <div>
      <wa-button hx-get="{% url 'new_bill' %}" hx-target="body" hx-swap="beforeend">
        <wa-icon slot="start" name="plus"></wa-icon>
        Add Bill
      </wa-button>
    </div>
  </div>
{% endblock %}
