{% extends "app/base.html" %}

{% block content %}
  {% csrf_token %}

  <div id="category-rules-page" style="max-width: 1000px; margin: 0 auto; padding: 1.5rem 1rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <h1 style="margin: 0; font-size: 1.75rem; font-weight: 600;">Category Rules</h1>
    </div>

    <p style="color: #666; margin-bottom: 1.5rem;">
      Category rules automatically categorize transactions based on keywords found in the merchant name or description.
      Rules are matched in order of priority (higher numbers first).
    </p>

    <!-- Add New Rule Form -->
    <wa-card style="margin-bottom: 1.5rem;">
      <div slot="header">
        <h3 style="margin: 0; font-size: 1.1rem;">Add New Rule</h3>
      </div>

      <form hx-post="/transactions/category-rules" style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 1rem; align-items: end;">
        <div>
          <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.9rem;">Keyword</label>
          <wa-input
            name="keyword"
            placeholder="e.g., 'Amazon', 'Starbucks'"
            required
          ></wa-input>
        </div>

        <div>
          <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.9rem;">Category</label>
          <wa-select name="category" required>
            <wa-option value="">Select category...</wa-option>
            {% for category in categories %}
              <wa-option value="{{ category.id }}">{{ category.name }}</wa-option>
            {% endfor %}
          </wa-select>
        </div>

        <div>
          <label style="display: block; margin-bottom: 0.25rem; font-weight: 500; font-size: 0.9rem;">Priority</label>
          <wa-input
            type="number"
            name="priority"
            value="0"
            min="0"
            max="100"
          ></wa-input>
        </div>

        <wa-button type="submit" appearance="primary">
          <wa-icon slot="start" name="plus"></wa-icon>
          Add Rule
        </wa-button>
      </form>
    </wa-card>

    <!-- Rules List -->
    {% if rules %}
      <wa-card>
        <div slot="header">
          <h3 style="margin: 0; font-size: 1.1rem;">Your Rules ({{ rules.count }})</h3>
        </div>

        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
          {% for rule in rules %}
            <div style="display: grid; grid-template-columns: 2fr 2fr 1fr auto; gap: 1rem; align-items: center; padding: 0.75rem; border-radius: 6px; background: #f8f9fa;">
              <div>
                <wa-input
                  name="keyword"
                  value="{{ rule.keyword }}"
                  hx-put="/transactions/category-rules/{{ rule.id }}"
                  hx-trigger="blur"
                ></wa-input>
              </div>

              <div>
                <wa-select
                  name="category"
                  value="{{ rule.category.id }}"
                  hx-put="/transactions/category-rules/{{ rule.id }}"
                  hx-trigger="change"
                >
                  {% for category in categories %}
                    <wa-option value="{{ category.id }}">{{ category.name }}</wa-option>
                  {% endfor %}
                </wa-select>
              </div>

              <div>
                <wa-input
                  type="number"
                  name="priority"
                  value="{{ rule.priority }}"
                  min="0"
                  max="100"
                  hx-put="/transactions/category-rules/{{ rule.id }}"
                  hx-trigger="blur"
                ></wa-input>
              </div>

              <wa-button
                appearance="plain"
                hx-delete="/transactions/category-rules/{{ rule.id }}"
                hx-target="closest div"
                hx-swap="outerHTML"
                hx-confirm="Are you sure you want to delete this rule?"
              >
                <wa-icon name="trash"></wa-icon>
              </wa-button>
            </div>
          {% endfor %}
        </div>
      </wa-card>
    {% else %}
      <wa-card>
        <div style="text-align: center; padding: 2rem; color: #666;">
          <wa-icon name="inbox" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></wa-icon>
          <p style="margin: 0; font-size: 1.1rem;">No category rules yet</p>
          <p style="margin: 0.5rem 0 0; font-size: 0.9rem;">Add your first rule above to start automatically categorizing transactions.</p>
        </div>
      </wa-card>
    {% endif %}

    <!-- Info Box -->
    <wa-alert style="margin-top: 1.5rem;" variant="info">
      <wa-icon slot="icon" name="circle-info"></wa-icon>
      <strong>How it works:</strong> When you upload transactions, the system searches for these keywords in the merchant name and description.
      If a match is found, the transaction is automatically assigned to the specified category.
      Higher priority rules are checked first.
    </wa-alert>
  </div>
{% endblock %}
