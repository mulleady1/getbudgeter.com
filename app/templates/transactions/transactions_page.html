{% extends "app/base.html" %}
{% load static %}
{% load myfilters %}

{% block extra_styles %}
  <link rel="stylesheet" href="{% static 'css/transactions_page.css' %}?v={{ UI_VERSION }}" />
{% endblock %}

{% block content %}

  {% if request.htmx %}
    <head>
      <link rel="stylesheet" href="{% static 'css/transactions_page.css' %}?v={{ UI_VERSION }}" />
    </head>
  {% endif %}
  {% csrf_token %}

  <script>
    var firstRun = true

    function init() {
      // Clear all checkboxes on page load to prevent browser restoration
      any("#transactions-table input[type='checkbox']").run((cb) => (cb.checked = false))

      const selectedCountSpan = me("#selected-count")
      const bulkActionBar = me("#bulk-action-bar")
      const bulkCategorySelect = me("#bulk-category")
      const applyButton = me("#bulk-apply")
      const cancelButton = me("#bulk-cancel")
      const selectAllCheckbox = me("#select-all")

      function updateBulkActionBar() {
        const checkboxes = any(".transaction-checkbox")
        const checkedCheckboxes = any(".transaction-checkbox:checked")
        const count = checkedCheckboxes.length

        if (count > 0) {
          bulkActionBar.style.display = "flex"
          selectedCountSpan.textContent = `${count} selected`
        } else {
          bulkActionBar.style.display = "none"
          bulkCategorySelect.value = ""
        }

        // Update select-all checkbox state
        if (count === 0) {
          selectAllCheckbox.checked = false
          selectAllCheckbox.indeterminate = false
        } else if (count === checkboxes.length) {
          selectAllCheckbox.checked = true
          selectAllCheckbox.indeterminate = false
        } else {
          selectAllCheckbox.checked = false
          selectAllCheckbox.indeterminate = true
        }

        // Enable/disable apply button
        applyButton.disabled = !bulkCategorySelect.value
      }

      if (firstRun) {
        // Individual checkboxes
        me("body").on("change", function (e) {
          if (e.target.classList.contains("transaction-checkbox")) {
            updateBulkActionBar()
          }
        })

        // Category select change
        bulkCategorySelect.on("change", function () {
          if (this.value === "__add_new__") {
            // Load new category dialog via htmx
            htmx.ajax("GET", "/transactions/categories/new", {
              target: "body",
              swap: "beforeend",
            })
            this.value = "" // Reset select
            applyButton.disabled = true
          } else if (this.value === "__manage__") {
            // Load manage categories dialog via htmx
            htmx.ajax("GET", "/transactions/categories", {
              target: "body",
              swap: "beforeend",
            })
            this.value = "" // Reset select
            applyButton.disabled = true
          } else {
            applyButton.disabled = !this.value
          }
        })

        // Cancel button
        cancelButton.on("click", function () {
          const checkboxes = any(".transaction-checkbox")
          checkboxes.run((cb) => (cb.checked = false))
          selectAllCheckbox.checked = false
          updateBulkActionBar()
        })
      }

      // Select all checkbox
      selectAllCheckbox.on("change", function () {
        const checkboxes = any(".transaction-checkbox")
        checkboxes.run((cb) => (cb.checked = this.checked))
        updateBulkActionBar()
      })

      firstRun = false
    }

    function resetCheckboxes() {
      any("#transactions-table input[type='checkbox']").run((cb) => (cb.checked = false))
      me("#select-all").checked = false
      me("#bulk-action-bar").style.display = "none"
    }

    onloadAdd(() => init())
    
    if (!document._didAddTransactionsPageOnLoad) {
      document._didAddTransactionsPageOnLoad = true

      me("body").on("htmx:load", (e) => {
        var el = e.detail.elt
        if (el.id === "transactions-table" || (el.tagName === "MAIN" && el.querySelector("#transactions-table") && !el._initialized)) {
          el._initialized = true
          init()
        }
      })
    }
  </script>

  <div id="transactions-page" style="max-width: 1200px; margin: 0 auto; padding: 1rem 1rem 100px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <span></span>
      <wa-button hx-get="{% url 'upload_csv' %}" hx-target="body" hx-swap="beforeend">
        <wa-icon slot="start" name="upload"></wa-icon>
        Upload CSV
      </wa-button>
    </div>

    <div id="transaction-list">
      {% if transactions or search_query or selected_category %}
        <!-- Search Bar -->
        <div
          class="search-filter-container"
          style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: flex-start;"
        >
          <div style="display: flex; gap: 1rem; align-items: flex-start; flex: 1;">
            <div style="flex: 1; max-width: 300px;">
              <div style="position: relative;">
                <wa-input
                  type="search"
                  name="q"
                  id="transaction-search"
                  placeholder="Search..."
                  value="{{ search_query|default:'' }}"
                  with-clear
                  hx-get="/transactions"
                  hx-trigger="keyup changed delay:300ms, search, wa-clear, reload-transactions from:body"
                  hx-target="#transactions-table"
                  hx-swap="outerHTML"
                  hx-push-url="true"
                  hx-include="#category-filter"
                  hx-on::after-request="if (event.detail.successful) resetCheckboxes()"
                >
                  <wa-icon slot="end" name="magnifying-glass"></wa-icon>
                </wa-input>
              </div>
              {% partialdef query-count inline %}
                {% if search_query %}
                  <div id="query-count" hx-swap-oob="true" style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                    Showing {{ showing_count }} of {{ total_count }} transactions
                  </div>
                {% else %}
                  <div id="query-count" hx-swap-oob="true"></div>
                {% endif %}
              {% endpartialdef query-count %}
            </div>

            <div style="min-width: 200px;">
              <wa-select
                id="category-filter"
                name="category"
                placeholder="All categories"
                value="{{ selected_category|default:'' }}"
                hx-get="/transactions"
                hx-trigger="change"
                hx-target="#transactions-table"
                hx-swap="outerHTML"
                hx-push-url="true"
                hx-include="#transaction-search"
                hx-on::after-request="if (event.detail.successful) resetCheckboxes()"
              >
                <wa-option value="">All categories</wa-option>
                <wa-option value="uncategorized">Uncategorized</wa-option>
                <wa-divider></wa-divider>
                {% for category in categories %}
                  <wa-option value="{{ category.id }}">{{ category.name }}</wa-option>
                {% endfor %}
              </wa-select>
            </div>
          </div>

          <!-- Bulk Action Bar -->
          <div id="bulk-action-bar" style="display: none; align-items: center; gap: 1rem;">
            <span id="selected-count" style="font-weight: 500;">0 selected</span>
            <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
              <wa-select id="bulk-category">
                <wa-option value="">Select...</wa-option>
                {% for category in categories %}
                  <wa-option value="{{ category.id }}">{{ category.name }}</wa-option>
                {% endfor %}
                <wa-divider></wa-divider>
                <wa-option value="__add_new__">New...</wa-option>
                <wa-option value="__manage__">Manage...</wa-option>
              </wa-select>
              <wa-button
                id="bulk-apply"
                disabled
                hx-post="/transactions/bulk-categorize"
                hx-swap="none"
                hx-on::config-request="
                const checkedBoxes = any('.transaction-checkbox:checked');
                const transactionIds = Array.from(checkedBoxes).map(cb => cb.value).join(',');
                const categoryId = me('#bulk-category').value;
                event.detail.parameters.transaction_ids = transactionIds;
                event.detail.parameters.category_id = categoryId;
              "
              >
                Apply
              </wa-button>
              <wa-button id="bulk-cancel" appearance="plain"> Cancel </wa-button>
            </div>
          </div>
        </div>

        {% partialdef category-dropdown %}
          <div style="display: inline-block;">
            <wa-dropdown class="category-dropdown" placement="bottom-start" distance="4">
              <span slot="trigger" style="cursor: pointer;">
                {% if transaction.category %}
                  <wa-badge
                    style="--wa-color-fill-loud: {{ transaction.category.color }}; --wa-color-on-loud: {{ transaction.category.get_text_color }};"
                    >{{ transaction.category.name }}</wa-badge
                  >
                {% else %}
                  <wa-badge variant="neutral">Uncategorized</wa-badge>
                {% endif %}
              </span>

              {% for category in categories %}
                <wa-dropdown-item
                  hx-get="/transactions/{{ transaction.id }}/token-selection/{{ category.id }}"
                  hx-target="body"
                  hx-swap="beforeend"
                >
                  {{ category.name }}
                </wa-dropdown-item>
              {% endfor %}
              <wa-divider></wa-divider>
              <wa-dropdown-item hx-get="/transactions/categories/new" hx-target="body" hx-swap="beforeend">
                New...
              </wa-dropdown-item>
              <wa-dropdown-item hx-get="/transactions/categories" hx-target="body" hx-swap="beforeend">
                Manage...
              </wa-dropdown-item>
            </wa-dropdown>
          </div>
        {% endpartialdef category-dropdown %}

        {% partialdef transactions-table inline %}
          <table id="transactions-table" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid #ddd;">
                <th style="text-align: left;  width: 40px;">
                  <input
                    type="checkbox"
                    id="select-all"
                    style="cursor: pointer; width: 18px; height: 18px;"
                    title="Select all"
                    autocomplete="off"
                  />
                </th>
                <th style="text-align: left;">Date</th>
                <th style="text-align: left;">Merchant</th>
                <th style="text-align: left;">Description</th>
                <th style="text-align: left;">Category</th>
                <th style="text-align: center; width: 80px;">Anomaly</th>
                <th style="text-align: right;">Amount</th>
              </tr>
            </thead>
            <tbody id="transactions-tbody">
              {% partial transaction-rows %}
            </tbody>
          </table>
        {% endpartialdef transactions-table %}

        {% partialdef transaction-rows %}
          {% for transaction in transactions %}
            {% partial transaction-row %}
          {% endfor %}
          {% if has_more %}
            <tr
              id="infinite-scroll-trigger"
              hx-get="/transactions?page={{ page|add:1 }}{% if search_query %}&q={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}"
              hx-trigger="revealed"
              hx-swap="outerHTML"
            >
              <td colspan="7" style="text-align: center; padding: 1rem; color: #666;">
                <wa-spinner></wa-spinner> Loading more...
              </td>
            </tr>
          {% endif %}
        {% endpartialdef transaction-rows %}

        {% partialdef transaction-row %}
          <tr style="border-bottom: 1px solid #eee;" data-transaction-id="{{ transaction.id }}">
            <td style=" width: 40px;">
              <input
                type="checkbox"
                class="transaction-checkbox"
                value="{{ transaction.id }}"
                style="cursor: pointer; width: 18px; height: 18px;"
                autocomplete="off"
              />
            </td>
            <td>{{ transaction.date|date:"n/j/Y" }}</td>
            <td>{{ transaction.merchant|truncatechars:30 }}</td>
            <td>{{ transaction.description|truncatechars:50 }}</td>
            <td>{% partial category-dropdown %}</td>
            <td style="text-align: center;">
              <input
                type="checkbox"
                class="anomaly-checkbox"
                {% if transaction.anomaly %}checked{% endif %}
                style="cursor: pointer; width: 18px; height: 18px;"
                autocomplete="off"
                hx-post="/transactions/{{ transaction.id }}/toggle-anomaly"
                hx-target="closest tr"
                hx-swap="outerHTML"
              />
            </td>
            <td
              style="text-align: right; font-weight: 500; {% if transaction.amount < 0 %}
                color: #d32f2f;
              {% else %}
                color: #388e3c;
              {% endif %}"
            >
              {{ transaction.amount|currency }}
            </td>
          </tr>
        {% endpartialdef transaction-row %}
      {% else %}
        <p style="text-align: center; padding: 2rem; color: #666;">No transactions yet. Upload a CSV to get started.</p>
      {% endif %}
    </div>
  </div>
{% endblock %}
