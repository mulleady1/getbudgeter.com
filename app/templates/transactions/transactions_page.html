{% extends "app/base.html" %}

{% block content %}
  {% csrf_token %}

  <div
    id="transactions-page"
    style="max-width: 1200px; margin: 0 auto; padding: 1.5rem 1rem 100px;"
    hx-on::config-request="event.detail.headers['X-CSRFToken'] = this.previousElementSibling.value"
  >
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
      <h1 style="margin: 0; font-size: 1.75rem;">Transactions</h1>
      <wa-button hx-get="{% url 'upload_csv' %}" hx-target="body" hx-swap="beforeend">
        <wa-icon slot="start" name="upload"></wa-icon>
        Upload CSV
      </wa-button>
    </div>

    <div id="transaction-list">
      {% if transactions %}
        <!-- Search Bar -->
        <div style="margin-bottom: 1rem;">
          <div style="position: relative; max-width: 500px;">
            <input
              type="text"
              name="q"
              id="transaction-search"
              placeholder="Search transactions by date, merchant, description, or amount..."
              value="{{ search_query|default:'' }}"
              hx-get="{% url 'transactions' %}"
              hx-trigger="keyup changed delay:300ms, search, reload-transactions from:body"
              hx-target="#transactions-table"
              hx-swap="outerHTML"
              hx-push-url="true"
              style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 1rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
            />
            <wa-icon
              name="magnifying-glass"
              style="position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none;"
            ></wa-icon>
          </div>
          {% if search_query %}
            <div style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
              Showing {{ showing_count }} of {{ total_count }} transactions
              {% if total_count > showing_count %}(limited to 100){% endif %}
            </div>
          {% endif %}
        </div>

        <!-- Bulk Action Bar -->
        <div
          id="bulk-action-bar"
          style="display: none; background: #f5f5f5; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; align-items: center; gap: 1rem;"
        >
          <span id="selected-count" style="font-weight: 500;">0 selected</span>
          <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
            <select
              id="bulk-category"
              style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; min-width: 200px;"
            >
              <option value="">Select category...</option>
              {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
              {% endfor %}
              <option value="__add_new__" style="border-top: 1px solid #ddd; margin-top: 4px; font-style: italic;">
                New...
              </option>
              <option value="__manage__" style="border-top: 1px solid #ddd; margin-top: 4px; font-style: italic;">
                Manage...
              </option>
            </select>
            <wa-button
              id="apply-bulk-category"
              disabled
              hx-post="{% url 'bulk_categorize_transactions' %}"
              hx-swap="none"
              hx-on::config-request="
                const checkedBoxes = document.querySelectorAll('.transaction-checkbox:checked');
                const transactionIds = Array.from(checkedBoxes).map(cb => cb.value).join(',');
                const categoryId = document.getElementById('bulk-category').value;
                event.detail.parameters.transaction_ids = transactionIds;
                event.detail.parameters.category_id = categoryId;
              "
            >
              Apply to Selected
            </wa-button>
            <wa-button id="cancel-bulk-selection" appearance="outlined"> Cancel </wa-button>
          </div>
        </div>

        {% partialdef transactions-table inline %}
          <table id="transactions-table" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid #ddd;">
                <th style="text-align: left; padding: 0.75rem; width: 40px;">
                  <input
                    type="checkbox"
                    id="select-all"
                    style="cursor: pointer; width: 18px; height: 18px;"
                    title="Select all"
                  />
                </th>
                <th style="text-align: left; padding: 0.75rem;">Date</th>
                <th style="text-align: left; padding: 0.75rem;">Merchant</th>
                <th style="text-align: left; padding: 0.75rem;">Description</th>
                <th style="text-align: left; padding: 0.75rem;">Category</th>
                <th style="text-align: right; padding: 0.75rem;">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for transaction in transactions %}
                {% include "transactions/transaction_list_item.html" %}
              {% endfor %}
            </tbody>
          </table>

          <script>
            ;(function () {
              const selectAllCheckbox = document.getElementById("select-all")
              const bulkActionBar = document.getElementById("bulk-action-bar")
              const selectedCountSpan = document.getElementById("selected-count")
              const bulkCategorySelect = document.getElementById("bulk-category")
              const applyButton = document.getElementById("apply-bulk-category")
              const cancelButton = document.getElementById("cancel-bulk-selection")

              function updateBulkActionBar() {
                const checkboxes = document.querySelectorAll(".transaction-checkbox")
                const checkedCheckboxes = document.querySelectorAll(".transaction-checkbox:checked")
                const count = checkedCheckboxes.length

                if (count > 0) {
                  bulkActionBar.style.display = "flex"
                  selectedCountSpan.textContent = `${count} selected`
                } else {
                  bulkActionBar.style.display = "none"
                  bulkCategorySelect.value = ""
                }

                // Update select-all checkbox state
                if (count === 0) {
                  selectAllCheckbox.checked = false
                  selectAllCheckbox.indeterminate = false
                } else if (count === checkboxes.length) {
                  selectAllCheckbox.checked = true
                  selectAllCheckbox.indeterminate = false
                } else {
                  selectAllCheckbox.checked = false
                  selectAllCheckbox.indeterminate = true
                }

                // Enable/disable apply button
                applyButton.disabled = !bulkCategorySelect.value
              }

              // Select all checkbox
              selectAllCheckbox.addEventListener("change", function () {
                const checkboxes = document.querySelectorAll(".transaction-checkbox")
                checkboxes.forEach((cb) => (cb.checked = this.checked))
                updateBulkActionBar()
              })

              // Individual checkboxes
              document.addEventListener("change", function (e) {
                if (e.target.classList.contains("transaction-checkbox")) {
                  updateBulkActionBar()
                }
              })

              // Category select change
              bulkCategorySelect.addEventListener("change", function () {
                if (this.value === "__add_new__") {
                  // Load new category dialog via htmx
                  htmx.ajax("GET", '{% url "new_category_dialog" %}', {
                    target: "body",
                    swap: "beforeend",
                  })
                  this.value = "" // Reset select
                  applyButton.disabled = true
                } else if (this.value === "__manage__") {
                  // Load manage categories dialog via htmx
                  htmx.ajax("GET", '{% url "category_list_create" %}', {
                    target: "body",
                    swap: "beforeend",
                  })
                  this.value = "" // Reset select
                  applyButton.disabled = true
                } else {
                  applyButton.disabled = !this.value
                }
              })

              // Cancel button
              cancelButton.addEventListener("click", function () {
                const checkboxes = document.querySelectorAll(".transaction-checkbox")
                checkboxes.forEach((cb) => (cb.checked = false))
                selectAllCheckbox.checked = false
                updateBulkActionBar()
              })
            })()
          </script>
        {% endpartialdef transactions-table %}
      {% else %}
        <p style="text-align: center; padding: 2rem; color: #666;">No transactions yet. Upload a CSV to get started.</p>
      {% endif %}
    </div>
  </div>
{% endblock %}
