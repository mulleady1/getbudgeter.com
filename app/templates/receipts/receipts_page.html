{% extends "app/base.html" %}
{% load static %}
{% load myfilters %}

{% block content %}
  {% if request.htmx %}
    <head>
    </head>
  {% endif %}
  {% csrf_token %}

  <div id="receipts-page" style="max-width: 1200px; margin: 0 auto; padding: 1rem 1rem 100px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
      <span></span>
      <wa-button hx-get="{% url 'upload_receipt' %}" hx-target="body" hx-swap="beforeend">
        <wa-icon slot="start" name="upload"></wa-icon>
        Upload Receipt
      </wa-button>
    </div>

    <div id="receipt-list">
      {% if receipts or search_query %}
        <!-- Search Bar -->
        <div class="search-filter-container" style="margin-bottom: 1rem;">
          <div style="display: flex; gap: 1rem; align-items: flex-start; flex: 1;">
            <div style="flex: 1; max-width: 300px;">
              <div style="position: relative;">
                <wa-input
                  type="search"
                  name="q"
                  id="receipt-search"
                  placeholder="Search..."
                  value="{{ search_query|default:'' }}"
                  with-clear
                  hx-get="/receipts"
                  hx-trigger="keyup changed delay:300ms, search, wa-clear"
                  hx-target="#receipts-page"
                  hx-swap="innerHTML"
                  hx-push-url="true"
                >
                  <wa-icon slot="end" name="magnifying-glass"></wa-icon>
                </wa-input>
              </div>
              {% if search_query %}
                <div style="margin-top: 0.5rem; color: #666; font-size: 0.9rem;">
                  Showing {{ showing_count }} of {{ total_count }} receipts
                </div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Receipts Grid -->
        <div id="receipts-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
          {% partial receipt-rows %}
        </div>

        {% partialdef receipt-rows %}
          {% for receipt in receipts %}
            <div class="receipt-card" style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
              <div style="aspect-ratio: 3/4; overflow: hidden; background: #f5f5f5;">
                {% if receipt.image %}
                  <img src="{{ receipt.image.url }}" alt="Receipt" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" hx-get="{% url 'receipt_detail' receipt.id %}" hx-target="body" hx-swap="beforeend" />
                {% endif %}
              </div>
              <div style="padding: 1rem;">
                <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem;">{{ receipt.merchant|default:"Unknown Merchant" }}</div>
                <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">{{ receipt.date|date:"M j, Y" }}</div>
                <div style="font-weight: 500; font-size: 1.2rem; color: #388e3c;">${{ receipt.total }}</div>
                <div style="margin-top: 0.75rem; font-size: 0.9rem; color: #666;">
                  {{ receipt.items.count }} item{{ receipt.items.count|pluralize }}
                </div>
                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                  <wa-button size="small" appearance="plain" hx-get="{% url 'receipt_detail' receipt.id %}" hx-target="body" hx-swap="beforeend">
                    <wa-icon slot="start" name="eye"></wa-icon>
                    View
                  </wa-button>
                  <wa-button
                    size="small"
                    appearance="plain"
                    hx-delete="{% url 'receipt_detail' receipt.id %}"
                    hx-confirm="Are you sure you want to delete this receipt?"
                    hx-target="closest .receipt-card"
                    hx-swap="outerHTML swap:0.5s"
                  >
                    <wa-icon slot="start" name="trash"></wa-icon>
                    Delete
                  </wa-button>
                </div>
              </div>
            </div>
          {% endfor %}
          {% if has_more %}
            <div
              id="infinite-scroll-trigger"
              hx-get="/receipts?page={{ page|add:1 }}{% if search_query %}&q={{ search_query }}{% endif %}"
              hx-trigger="revealed"
              hx-swap="outerHTML"
              style="grid-column: 1 / -1; text-align: center; padding: 1rem; color: #666;"
            >
              <wa-spinner></wa-spinner> Loading more...
            </div>
          {% endif %}
        {% endpartialdef receipt-rows %}

      {% else %}
        <p style="text-align: center; padding: 2rem; color: #666;">No receipts yet. Upload a receipt image to get started.</p>
      {% endif %}
    </div>
  </div>
{% endblock %}
