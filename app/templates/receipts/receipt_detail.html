<wa-dialog
  label="Receipt Details"
  class="receipt-detail-dialog"
  open
  data-no-autoremove
  hx-on::wa-hide="this.remove()"
  style="--wa-size-xl: 800px;"
>
  <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 1.5rem;">
    <!-- Receipt Image -->
    <div>
      <div style="border: 1px solid #ddd; border-radius: 4px; overflow: hidden; background: #f5f5f5;">
        {% if receipt.image %}
          <img src="{{ receipt.image.url }}" alt="Receipt" style="width: 100%; height: auto; display: block;" />
        {% endif %}
      </div>
      <div style="margin-top: 1rem;">
        <div style="font-weight: 600; margin-bottom: 0.5rem;">Receipt Info</div>
        <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
          <span style="color: #666;">Merchant:</span> {{ receipt.merchant|default:"Unknown" }}
        </div>
        <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
          <span style="color: #666;">Date:</span> {{ receipt.date|date:"M j, Y" }}
        </div>
        <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">
          <span style="color: #666;">Total:</span> <strong style="color: #388e3c;">${{ receipt.total }}</strong>
        </div>
      </div>
    </div>

    <!-- Receipt Items -->
    <div>
      <div style="font-weight: 600; margin-bottom: 1rem;">Items ({{ items.count }})</div>
      {% if items %}
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid #ddd;">
              <th style="text-align: left; padding: 0.5rem;">Description</th>
              <th style="text-align: left; padding: 0.5rem;">Category</th>
              <th style="text-align: right; padding: 0.5rem;">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              {% partial item-row %}
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="color: #666; font-style: italic;">No items extracted from this receipt.</p>
      {% endif %}
    </div>
  </div>

  <div style="margin-top: 1.5rem; display: flex; gap: 0.5rem; justify-content: flex-end; border-top: 1px solid #ddd; padding-top: 1rem;">
    <wa-button appearance="plain" onclick="me('.receipt-detail-dialog').open = false">Close</wa-button>
    <wa-button
      variant="danger"
      appearance="plain"
      hx-delete="{% url 'receipt_detail' receipt.id %}"
      hx-confirm="Are you sure you want to delete this receipt?"
      hx-on::after-request="me('.receipt-detail-dialog').open = false; htmx.ajax('GET', '/receipts', {target:'#receipts-page', swap:'innerHTML'})"
    >
      <wa-icon slot="start" name="trash"></wa-icon>
      Delete Receipt
    </wa-button>
  </div>
</wa-dialog>

{% partialdef item-row %}
  <tr style="border-bottom: 1px solid #eee;">
    <td style="padding: 0.5rem;">{{ item.description|truncatechars:40 }}</td>
    <td style="padding: 0.5rem;">
      <wa-dropdown placement="bottom-start" distance="4">
        <span slot="trigger" style="cursor: pointer;">
          {% if item.category %}
            <wa-badge
              style="--wa-color-fill-loud: {{ item.category.color }}; --wa-color-on-loud: {{ item.category.get_text_color }};"
            >{{ item.category.name }}</wa-badge>
          {% else %}
            <wa-badge variant="neutral">Uncategorized</wa-badge>
          {% endif %}
        </span>

        {% for category in categories %}
          <wa-dropdown-item
            hx-put="{% url 'update_receipt_item_category' item.id %}"
            hx-target="closest tr"
            hx-swap="outerHTML"
            hx-vals='{"category": "{{ category.id }}"}'
          >
            {{ category.name }}
          </wa-dropdown-item>
        {% endfor %}
      </wa-dropdown>
    </td>
    <td style="text-align: right; padding: 0.5rem; font-weight: 500; color: #388e3c;">${{ item.amount }}</td>
  </tr>
{% endpartialdef item-row %}
