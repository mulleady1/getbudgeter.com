{% extends "app/base.html" %}
{% load static %}
{% load myfilters %}
{% load humanize %}

{% block extra_styles %}
  <link rel="stylesheet" href="{% static 'css/analytics_page.css' %}?v={{ UI_VERSION }}" />
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}

{% if request.htmx %}
  <head>
    <link rel="stylesheet" href="{% static 'css/analytics_page.css' %}?v={{ UI_VERSION }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  </head>
{% endif %}

  <div class="analytics-container">
    <!-- Data Source Toggle -->
    <div style="margin-bottom: 1.5rem; display: flex; justify-content: center;">
      <wa-select
        id="data-source-select"
        name="data_source"
        value="{% if data_source %}{{ data_source }}{% else %}transactions{% endif %}"
        style="width: 200px;"
      >
        <script>
          me().on('change', (e) => {
            const form = me("#date-range-form")
            form.requestSubmit()
          })
        </script>
        <wa-option value="transactions">Transactions</wa-option>
        <wa-option value="receipts">Receipts</wa-option>
      </wa-select>
    </div>

    <!-- Date Range Selector -->
    <form
      id="date-range-form"
      method="get"
    >
      <input type="hidden" name="data_source" value="{{ data_source|default:'transactions' }}" />
      <script>
        // Set up debounced submit on the form itself
        var form = me()
        form.debouncedSubmit = () => {
          clearTimeout(form._submitTimeout)
          form._submitTimeout = setTimeout(() => form.requestSubmit(), 500)
        }
      </script>

      <div class="form-fields">
        <!-- Mode Selection -->
        <div class="mode-selector">
          <wa-select
            label="Date Range"
            id="mode-select"
            name="mode"
            value="{% if mode %}{{ mode }}{% else %}month{% endif %}"
          >
            <script>
              me().on('change', (e) => {
                const mode = e.target.value
                const form = me("#date-range-form")
                const monthContainer = me("#month-input-container")
                const yearContainer = me("#year-input-container")
                const customDates = me("#custom-dates")
                const applyButton = me("#apply-button")

                if (mode === "month") {
                  monthContainer.style.display = "flex"
                  yearContainer.style.display = "none"
                  customDates.style.display = "none"
                  applyButton.style.display = "none"
                  form.requestSubmit()
                } else if (mode === "year") {
                  monthContainer.style.display = "none"
                  yearContainer.style.display = "flex"
                  customDates.style.display = "none"
                  applyButton.style.display = "none"
                  form.requestSubmit()
                } else {
                  monthContainer.style.display = "none"
                  yearContainer.style.display = "none"
                  customDates.style.display = "flex"
                  applyButton.style.display = "flex"
                }
              })
            </script>
            <wa-option value="month">Month</wa-option>
            <wa-option value="year">Year</wa-option>
            <wa-option value="custom">Custom</wa-option>
          </wa-select>
        </div>

        <!-- Month Input -->
        <div
          id="month-input-container"
          style="display: {% if mode == 'month' %}flex{% else %}none{% endif %};"
        >
          <div class="month-arrow-btn">
            <wa-button size="small" appearance="plain" type="button">
              <script>
                me().on('click', () => {
                  const form = me("#date-range-form")
                  const monthInput = me("#month-input")
                  const currentValue = monthInput.value
                  if (!currentValue) return

                  const [year, month] = currentValue.split("-").map(Number)
                  let newMonth = month - 1
                  let newYear = year

                  if (newMonth < 1) {
                    newMonth = 12
                    newYear = year - 1
                  }

                  monthInput.value = `${newYear}-${String(newMonth).padStart(2, "0")}`
                  form.debouncedSubmit()
                })
              </script>
              <wa-icon name="chevron-left" label="Previous month"></wa-icon>
            </wa-button>
          </div>

          <div class="month-input-wrapper">
            <wa-input
              label="Month"
              type="month"
              id="month-input"
              name="month"
              value="{{ month }}"
            >
              <script>
                me().on('change', () => {
                  me("#date-range-form").debouncedSubmit()
                })
              </script>
            </wa-input>
          </div>

          <div class="month-arrow-btn">
            <wa-button size="small" appearance="plain" type="button">
              <script>
                me().on('click', () => {
                  const form = me("#date-range-form")
                  const monthInput = me("#month-input")
                  const currentValue = monthInput.value
                  if (!currentValue) return

                  const [year, month] = currentValue.split("-").map(Number)
                  let newMonth = month + 1
                  let newYear = year

                  if (newMonth > 12) {
                    newMonth = 1
                    newYear = year + 1
                  }

                  monthInput.value = `${newYear}-${String(newMonth).padStart(2, "0")}`
                  form.debouncedSubmit()
                })
              </script>
              <wa-icon name="chevron-right" label="Next month"></wa-icon>
            </wa-button>
          </div>
        </div>

        <!-- Year Input -->
        <div
          id="year-input-container"
          style="display: {% if mode == 'year' %}flex{% else %}none{% endif %};"
        >
          <div class="month-arrow-btn">
            <wa-button size="small" appearance="plain" type="button">
              <script>
                me().on('click', () => {
                  const form = me("#date-range-form")
                  const yearInput = me("#year-input")
                  const currentValue = parseInt(yearInput.value)
                  if (!currentValue) return

                  yearInput.value = currentValue - 1
                  form.debouncedSubmit()
                })
              </script>
              <wa-icon name="chevron-left" label="Previous year"></wa-icon>
            </wa-button>
          </div>

          <div class="month-input-wrapper">
            <wa-input
              label="Year"
              type="number"
              id="year-input"
              name="year"
              value="{{ year }}"
              min="2000"
              max="2099"
            >
              <script>
                me().on('change', () => {
                  me("#date-range-form").debouncedSubmit()
                })
              </script>
            </wa-input>
          </div>

          <div class="month-arrow-btn">
            <wa-button size="small" appearance="plain" type="button">
              <script>
                me().on('click', () => {
                  const form = me("#date-range-form")
                  const yearInput = me("#year-input")
                  const currentValue = parseInt(yearInput.value)
                  if (!currentValue) return

                  yearInput.value = currentValue + 1
                  form.debouncedSubmit()
                })
              </script>
              <wa-icon name="chevron-right" label="Next year"></wa-icon>
            </wa-button>
          </div>
        </div>

        <!-- Custom Date Range Inputs -->
        <div
          id="custom-dates"
          style="display: {% if mode == 'custom' %}flex{% else %}none{% endif %};"
        >
          <wa-input
            label="Start Date"
            type="date"
            id="custom-start"
            name="start_date"
            value="{{ custom_start_date }}"
          ></wa-input>
          <wa-input
            label="End Date"
            type="date"
            id="custom-end"
            name="end_date"
            value="{{ custom_end_date }}"
          ></wa-input>
        </div>

        <div
          id="apply-button"
          style="display: {% if mode == 'custom' %}flex{% else %}none{% endif %};"
        >
          <wa-button type="submit">Apply</wa-button>
        </div>
      </div>
    </form>

    <div id="analytics-content">
      <div class="stats-summary">
        <div class="stat-item">
          <p class="stat-label">Total {% if data_source == 'receipts' %}Receipts{% else %}Transactions{% endif %}</p>
          <p class="stat-value">{{ total_transactions|intcomma }}</p>
        </div>
        <div class="stat-item">
          <p class="stat-label">Total Spent</p>
          <p class="stat-value negative">
            {{ total_spent|currency }}
          </p>
        </div>
        <div class="stat-item">
          <p class="stat-label">Date Range</p>
          <p class="stat-value">
            {{ start_date|date:"n/j/Y" }} - {{ end_date|date:"n/j/Y" }}
          </p>
        </div>
      </div>

      {% if category_chart_data %}
        <div class="chart-container category-chart-section" style="padding-bottom: 3rem;">
          <div class="chart-filter">
            <wa-select
              id="category-sort"
              name="category-sort"
              size="small"
              value="amount"
            >
              <wa-option value="name">Sort by Name</wa-option>
              <wa-option value="amount">Sort by Amount</wa-option>
            </wa-select>
          </div>
          <canvas id="category-chart"></canvas>
          <script>
            function createCategoryChart() {
              const originalData = {{ category_chart_data|safe }}
              const categoryCtx = me('#category-chart').getContext('2d')
              const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
              ]

              let categoryChart = null

              function sortData(sortBy) {
                // Combine labels and data into pairs
                const pairs = originalData.labels.map((label, i) => ({
                  label,
                  value: originalData.data[i]
                }))

                // Sort based on selection
                if (sortBy === 'name') {
                  pairs.sort((a, b) => a.label.localeCompare(b.label))
                } else {
                  pairs.sort((a, b) => b.value - a.value)
                }

                // Split back into separate arrays
                return {
                  labels: pairs.map(p => p.label),
                  data: pairs.map(p => p.value)
                }
              }

              function createChart(sortBy) {
                // Destroy existing chart
                if (categoryChart) {
                  categoryChart.destroy()
                }

                const sortedData = sortData(sortBy)

                categoryChart = new Chart(categoryCtx, {
                  type: 'pie',
                  data: {
                    labels: sortedData.labels,
                    datasets: [{
                      data: sortedData.data,
                      backgroundColor: colors
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      title: {
                        display: true,
                        text: 'Spending by Category',
                        font: { size: 16 }
                      },
                      legend: {
                        position: 'bottom'
                      },
                      tooltip: {
                        callbacks: {
                          label: (context) => {
                            const label = context.label || ''
                            const value = context.parsed || 0
                            return label + ': $' + value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                          }
                        }
                      }
                    }
                  }
                })
              }

              // Initial chart with amount sort
              createChart('amount')

              // Listen for sort changes
              me('#category-sort').on('change', (e) => {
                createChart(e.target.value)
              })
            }

            waitFor(() => typeof window.Chart !== 'undefined').then(() => createCategoryChart())
          </script>
        </div>
      {% endif %}

      <div id="trend-chart-container">
        {% include "analytics/trend_chart_partial.html" %}
      </div>

      {% if data_source != 'receipts' %}
        <div id="merchant-chart-container">
          {% include "analytics/merchant_chart_partial.html" %}
        </div>
      {% endif %}

      {% if not category_chart_data and not trend_chart_data and not merchant_chart_data %}
        <p class="empty-state">
          No {% if data_source == 'receipts' %}receipt{% else %}transaction{% endif %} data available. Upload some {% if data_source == 'receipts' %}receipts{% else %}transactions{% endif %} to see analytics.
        </p>
      {% endif %}
    </div>
  </div>
{% endblock %}
