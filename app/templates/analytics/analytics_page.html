{% extends "app/base.html" %}

{% load static %}

{% block extra_styles %}
  <link rel="stylesheet" href="/static/css/analytics_page.css?v={{ UI_VERSION }}" />
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/plotly.min.js' %}"></script>
{% endblock %}

{% block content %}

  <div class="analytics-container">
    <!-- Date Range Selector -->
    <form
      id="date-range-form"
      method="get"
    >
      <div class="form-fields">
        <!-- Mode Selection -->
        <div class="mode-selector">
          <wa-select
            label="Date Range"
            id="mode-select"
            name="mode"
            value="{% if mode %}{{ mode }}{% else %}month{% endif %}"
            onchange="handleModeChange(this.value)"
          >
            <wa-option value="month">Month</wa-option>
            <wa-option value="year">Year</wa-option>
            <wa-option value="custom">Custom</wa-option>
          </wa-select>
        </div>

        <!-- Month Input -->
        <div
          id="month-input-container"
          style="display: {% if mode == 'month' %}flex{% else %}none{% endif %};"
        >
          <div class="month-arrow-btn">
            <wa-button size="small" onclick="changeMonth(-1)" appearance="plain" type="button">
              <wa-icon name="chevron-left" label="Previous month"></wa-icon>
            </wa-button>
          </div>

          <div class="month-input-wrapper">
            <wa-input
              label="Month"
              type="month"
              id="month-input"
              name="month"
              value="{{ month }}"
              onchange="debouncedSubmit()"
            ></wa-input>
          </div>

          <div class="month-arrow-btn">
            <wa-button size="small" onclick="changeMonth(1)" appearance="plain" type="button">
              <wa-icon name="chevron-right" label="Next month"></wa-icon>
            </wa-button>
          </div>
        </div>

        <!-- Year Input -->
        <div
          id="year-input-container"
          style="display: {% if mode == 'year' %}flex{% else %}none{% endif %};"
        >
          <div class="month-arrow-btn">
            <wa-button size="small" onclick="changeYear(-1)" appearance="plain" type="button">
              <wa-icon name="chevron-left" label="Previous year"></wa-icon>
            </wa-button>
          </div>

          <div class="month-input-wrapper">
            <wa-input
              label="Year"
              type="number"
              id="year-input"
              name="year"
              value="{{ year }}"
              min="2000"
              max="2099"
              onchange="debouncedSubmit()"
            ></wa-input>
          </div>

          <div class="month-arrow-btn">
            <wa-button size="small" onclick="changeYear(1)" appearance="plain" type="button">
              <wa-icon name="chevron-right" label="Next year"></wa-icon>
            </wa-button>
          </div>
        </div>

        <!-- Custom Date Range Inputs -->
        <div
          id="custom-dates"
          style="display: {% if mode == 'custom' %}flex{% else %}none{% endif %};"
        >
          <wa-input
            label="Start Date"
            type="date"
            id="custom-start"
            name="start_date"
            value="{{ custom_start_date }}"
          ></wa-input>
          <wa-input
            label="End Date"
            type="date"
            id="custom-end"
            name="end_date"
            value="{{ custom_end_date }}"
          ></wa-input>
        </div>

        <div
          id="apply-button"
          style="display: {% if mode == 'custom' %}flex{% else %}none{% endif %};"
        >
          <wa-button type="submit">Apply</wa-button>
        </div>
      </div>
    </form>

    <script>
      let formSubmitTimeout = null

      function debouncedSubmit() {
        clearTimeout(formSubmitTimeout)
        formSubmitTimeout = setTimeout(() => {
          document.getElementById("date-range-form").requestSubmit()
        }, 500)
      }

      function changeMonth(direction) {
        const monthInput = document.getElementById("month-input")
        const currentValue = monthInput.value

        if (!currentValue) return

        const [year, month] = currentValue.split("-").map(Number)
        let newMonth = month + direction
        let newYear = year

        if (newMonth < 1) {
          newMonth = 12
          newYear = year - 1
        } else if (newMonth > 12) {
          newMonth = 1
          newYear = year + 1
        }

        const newValue = `${newYear}-${String(newMonth).padStart(2, "0")}`
        monthInput.value = newValue

        // Debounce the form submission
        debouncedSubmit()
      }

      function changeYear(direction) {
        const yearInput = document.getElementById("year-input")
        const currentValue = parseInt(yearInput.value)

        if (!currentValue) return

        const newYear = currentValue + direction
        yearInput.value = newYear

        // Debounce the form submission
        debouncedSubmit()
      }

      function handleModeChange(mode) {
        const monthContainer = document.getElementById("month-input-container")
        const yearContainer = document.getElementById("year-input-container")
        const customDates = document.getElementById("custom-dates")
        const applyButton = document.getElementById("apply-button")
        const form = document.getElementById("date-range-form")

        if (mode === "month") {
          monthContainer.style.display = "flex"
          yearContainer.style.display = "none"
          customDates.style.display = "none"
          applyButton.style.display = "none"
          // Auto-submit for month mode
          form.requestSubmit()
        } else if (mode === "year") {
          monthContainer.style.display = "none"
          yearContainer.style.display = "flex"
          customDates.style.display = "none"
          applyButton.style.display = "none"
          // Auto-submit for year mode
          form.requestSubmit()
        } else {
          monthContainer.style.display = "none"
          yearContainer.style.display = "none"
          customDates.style.display = "flex"
          applyButton.style.display = "flex"
        }
      }
    </script>

    <div id="analytics-content">
      <div class="stats-summary">
        <div class="stat-item">
          <p class="stat-label">Total Transactions</p>
          <p class="stat-value">{{ total_transactions }}</p>
        </div>
        <div class="stat-item">
          <p class="stat-label">Total Spent</p>
          <p class="stat-value negative">
            ${{ total_spent|floatformat:2 }}
          </p>
        </div>
        <div class="stat-item">
          <p class="stat-label">Date Range</p>
          <p class="stat-date">
            {{ start_date|date:"m/d/Y" }} - {{ end_date|date:"m/d/Y" }}
          </p>
        </div>
      </div>

      {% if category_chart %}
        <div class="chart-container">
          {{ category_chart|safe }}
        </div>
      {% endif %}

      {% if trend_chart %}
        <div class="chart-container">
          {{ trend_chart|safe }}
        </div>
      {% endif %}

      {% if merchant_chart %}
        <div class="chart-container">
          {{ merchant_chart|safe }}
        </div>
      {% endif %}

      {% if not category_chart and not trend_chart and not merchant_chart %}
        <p class="empty-state">
          No transaction data available. Upload some transactions to see analytics.
        </p>
      {% endif %}
    </div>
  </div>
{% endblock %}
