{% extends "app/base.html" %}

{% load static %}

{% block content %}

{% if request.htmx %}
  <head>
    <link rel="stylesheet" href="/static/css/analytics_page.css?v={{ UI_VERSION }}" />
    <script src="{% static 'js/plotly.min.js' %}"></script>
  </head>
{% endif %}

  <div class="analytics-container">
    <!-- Date Range Selector -->
    <form
      id="date-range-form"
      method="get"
    >
      <script>
        // Set up debounced submit on the form itself
        var form = me()
        form.debouncedSubmit = () => {
          clearTimeout(form._submitTimeout)
          form._submitTimeout = setTimeout(() => form.requestSubmit(), 500)
        }
      </script>

      <div class="form-fields">
        <!-- Mode Selection -->
        <div class="mode-selector">
          <wa-select
            label="Date Range"
            id="mode-select"
            name="mode"
            value="{% if mode %}{{ mode }}{% else %}month{% endif %}"
          >
            <script>
              me().on('change', (e) => {
                const mode = e.target.value
                const form = me("#date-range-form")
                const monthContainer = me("#month-input-container")
                const yearContainer = me("#year-input-container")
                const customDates = me("#custom-dates")
                const applyButton = me("#apply-button")

                if (mode === "month") {
                  monthContainer.style.display = "flex"
                  yearContainer.style.display = "none"
                  customDates.style.display = "none"
                  applyButton.style.display = "none"
                  form.requestSubmit()
                } else if (mode === "year") {
                  monthContainer.style.display = "none"
                  yearContainer.style.display = "flex"
                  customDates.style.display = "none"
                  applyButton.style.display = "none"
                  form.requestSubmit()
                } else {
                  monthContainer.style.display = "none"
                  yearContainer.style.display = "none"
                  customDates.style.display = "flex"
                  applyButton.style.display = "flex"
                }
              })
            </script>
            <wa-option value="month">Month</wa-option>
            <wa-option value="year">Year</wa-option>
            <wa-option value="custom">Custom</wa-option>
          </wa-select>
        </div>

        <!-- Month Input -->
        <div
          id="month-input-container"
          style="display: {% if mode == 'month' %}flex{% else %}none{% endif %};"
        >
          <div class="month-arrow-btn">
            <wa-button size="small" appearance="plain" type="button">
              <script>
                me().on('click', () => {
                  const form = me("#date-range-form")
                  const monthInput = me("#month-input")
                  const currentValue = monthInput.value
                  if (!currentValue) return

                  const [year, month] = currentValue.split("-").map(Number)
                  let newMonth = month - 1
                  let newYear = year

                  if (newMonth < 1) {
                    newMonth = 12
                    newYear = year - 1
                  }

                  monthInput.value = `${newYear}-${String(newMonth).padStart(2, "0")}`
                  form.debouncedSubmit()
                })
              </script>
              <wa-icon name="chevron-left" label="Previous month"></wa-icon>
            </wa-button>
          </div>

          <div class="month-input-wrapper">
            <wa-input
              label="Month"
              type="month"
              id="month-input"
              name="month"
              value="{{ month }}"
            >
              <script>
                me().on('change', () => {
                  me("#date-range-form").debouncedSubmit()
                })
              </script>
            </wa-input>
          </div>

          <div class="month-arrow-btn">
            <wa-button size="small" appearance="plain" type="button">
              <script>
                me().on('click', () => {
                  const form = me("#date-range-form")
                  const monthInput = me("#month-input")
                  const currentValue = monthInput.value
                  if (!currentValue) return

                  const [year, month] = currentValue.split("-").map(Number)
                  let newMonth = month + 1
                  let newYear = year

                  if (newMonth > 12) {
                    newMonth = 1
                    newYear = year + 1
                  }

                  monthInput.value = `${newYear}-${String(newMonth).padStart(2, "0")}`
                  form.debouncedSubmit()
                })
              </script>
              <wa-icon name="chevron-right" label="Next month"></wa-icon>
            </wa-button>
          </div>
        </div>

        <!-- Year Input -->
        <div
          id="year-input-container"
          style="display: {% if mode == 'year' %}flex{% else %}none{% endif %};"
        >
          <div class="month-arrow-btn">
            <wa-button size="small" appearance="plain" type="button">
              <script>
                me().on('click', () => {
                  const form = me("#date-range-form")
                  const yearInput = me("#year-input")
                  const currentValue = parseInt(yearInput.value)
                  if (!currentValue) return

                  yearInput.value = currentValue - 1
                  form.debouncedSubmit()
                })
              </script>
              <wa-icon name="chevron-left" label="Previous year"></wa-icon>
            </wa-button>
          </div>

          <div class="month-input-wrapper">
            <wa-input
              label="Year"
              type="number"
              id="year-input"
              name="year"
              value="{{ year }}"
              min="2000"
              max="2099"
            >
              <script>
                me().on('change', () => {
                  me("#date-range-form").debouncedSubmit()
                })
              </script>
            </wa-input>
          </div>

          <div class="month-arrow-btn">
            <wa-button size="small" appearance="plain" type="button">
              <script>
                me().on('click', () => {
                  const form = me("#date-range-form")
                  const yearInput = me("#year-input")
                  const currentValue = parseInt(yearInput.value)
                  if (!currentValue) return

                  yearInput.value = currentValue + 1
                  form.debouncedSubmit()
                })
              </script>
              <wa-icon name="chevron-right" label="Next year"></wa-icon>
            </wa-button>
          </div>
        </div>

        <!-- Custom Date Range Inputs -->
        <div
          id="custom-dates"
          style="display: {% if mode == 'custom' %}flex{% else %}none{% endif %};"
        >
          <wa-input
            label="Start Date"
            type="date"
            id="custom-start"
            name="start_date"
            value="{{ custom_start_date }}"
          ></wa-input>
          <wa-input
            label="End Date"
            type="date"
            id="custom-end"
            name="end_date"
            value="{{ custom_end_date }}"
          ></wa-input>
        </div>

        <div
          id="apply-button"
          style="display: {% if mode == 'custom' %}flex{% else %}none{% endif %};"
        >
          <wa-button type="submit">Apply</wa-button>
        </div>
      </div>
    </form>

    <div id="analytics-content">
      <div class="stats-summary">
        <div class="stat-item">
          <p class="stat-label">Total Transactions</p>
          <p class="stat-value">{{ total_transactions }}</p>
        </div>
        <div class="stat-item">
          <p class="stat-label">Total Spent</p>
          <p class="stat-value negative">
            ${{ total_spent|floatformat:2 }}
          </p>
        </div>
        <div class="stat-item">
          <p class="stat-label">Date Range</p>
          <p class="stat-date">
            {{ start_date|date:"m/d/Y" }} - {{ end_date|date:"m/d/Y" }}
          </p>
        </div>
      </div>

      {% if category_chart %}
        <div class="chart-container">
          {{ category_chart|safe }}
        </div>
      {% endif %}

      {% if trend_chart %}
        <div class="chart-container">
          {{ trend_chart|safe }}
        </div>
      {% endif %}

      {% if merchant_chart %}
        <div class="chart-container">
          {{ merchant_chart|safe }}
        </div>
      {% endif %}

      {% if not category_chart and not trend_chart and not merchant_chart %}
        <p class="empty-state">
          No transaction data available. Upload some transactions to see analytics.
        </p>
      {% endif %}
    </div>
  </div>
{% endblock %}
