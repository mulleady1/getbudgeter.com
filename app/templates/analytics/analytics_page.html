{% extends "app/base.html" %}

{% block content %}
  <div style="max-width: 1200px; margin: 0 auto; padding: 1.5rem 1rem 100px;">
    <h1 style="margin: 0 0 1.5rem 0; font-size: 1.75rem;">Analytics</h1>

    <!-- Date Range Selector -->
    <form
      id="date-range-form"
      method="get"
      style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
    >
      <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <div style="flex: 0 0 auto;">
          <wa-select label="Date Range" id="range-preset" name="range_preset" onchange="handleRangeChange(this.value)">
            <wa-option value="this_month" {% if range_preset == 'this_month' %}selected{% endif %}
              >This Month</wa-option
            >
            <wa-option value="last_month" {% if range_preset == 'last_month' %}selected{% endif %}
              >Last Month</wa-option
            >
            <wa-option value="this_quarter" {% if range_preset == 'this_quarter' %}selected{% endif %}>
              This Quarter
            </wa-option>
            <wa-option value="this_year" {% if range_preset == 'this_year' %}selected{% endif %}>This Year</wa-option>
            <wa-option value="last_6_months" {% if range_preset == 'last_6_months' %}selected{% endif %}>
              Past 6 Months
            </wa-option>
            <wa-option value="all_time" {% if range_preset == 'all_time' %}selected{% endif %}>All Time</wa-option>
            <wa-option value="custom" {% if range_preset == 'custom' %}selected{% endif %}>Custom</wa-option>
          </wa-select>
        </div>

        <div
          id="custom-dates"
          style="display: {% if range_preset == 'custom' %}flex{% else %}none{% endif %}; gap: 1rem; align-self: flex-end;"
        >
          <wa-input
            label="Start Date"
            type="date"
            id="custom-start"
            name="start_date"
            value="{{ custom_start_date }}"
          ></wa-input>
          <wa-input
            label="End Date"
            type="date"
            id="custom-end"
            name="end_date"
            value="{{ custom_end_date }}"
          ></wa-input>
        </div>

        <div
          id="apply-button"
          style="flex: 0 0 auto; display: {% if range_preset == 'custom' %}flex{% else %}none{% endif %}; align-items: flex-end; align-self: flex-end;"
        >
          <wa-button type="submit">Apply</wa-button>
        </div>
      </div>
    </form>

    <script>
      function handleRangeChange(value) {
        const customDates = document.getElementById("custom-dates")
        const applyButton = document.getElementById("apply-button")
        const form = document.getElementById("date-range-form")

        if (value === "custom") {
          customDates.style.display = "flex"
          applyButton.style.display = "flex"
        } else {
          customDates.style.display = "none"
          applyButton.style.display = "none"
          // Auto-submit form for preset selections
          form.submit()
        }
      }
    </script>

    <div
      style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; gap: 2rem; justify-content: space-around;"
    >
      <div>
        <p style="margin: 0; color: #666; font-size: 0.875rem;">Total Transactions</p>
        <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; font-weight: 600;">{{ total_transactions }}</p>
      </div>
      <div>
        <p style="margin: 0; color: #666; font-size: 0.875rem;">Total Spent</p>
        <p style="margin: 0.25rem 0 0 0; font-size: 1.5rem; font-weight: 600; color: #d32f2f;">
          ${{ total_spent|floatformat:2 }}
        </p>
      </div>
      <div>
        <p style="margin: 0; color: #666; font-size: 0.875rem;">Date Range</p>
        <p style="margin: 0.25rem 0 0 0; font-size: 0.875rem;">
          {{ start_date|date:"m/d/Y" }} - {{ end_date|date:"m/d/Y" }}
        </p>
      </div>
    </div>

    {% if category_chart %}
      <div
        style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
      >
        {{ category_chart|safe }}
      </div>
    {% endif %}

    {% if trend_chart %}
      <div
        style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
      >
        {{ trend_chart|safe }}
      </div>
    {% endif %}

    {% if merchant_chart %}
      <div
        style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"
      >
        {{ merchant_chart|safe }}
      </div>
    {% endif %}

    {% if not category_chart and not trend_chart and not merchant_chart %}
      <p style="text-align: center; padding: 3rem; color: #666;">
        No transaction data available. Upload some transactions to see analytics.
      </p>
    {% endif %}
  </div>
{% endblock %}
